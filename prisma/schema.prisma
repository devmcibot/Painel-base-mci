datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  MEDICO
}

enum UserStatus {
  ACTIVE
  BLOCKED
}

enum Status {
  ABERTA
  CONCLUIDA
  CANCELADA
}

model User {
  id        Int        @id @default(autoincrement())
  role      Role       @default(MEDICO)
  status    UserStatus @default(ACTIVE)
  email     String     @unique
  name      String
  hashedPwd String
  createdAt DateTime   @default(now())
  medico    Medico?
}

model Medico {
  id        Int            @id @default(autoincrement())
  userId    Int            @unique
  crm       String?
  User      User           @relation(fields: [userId], references: [id])
  pacientes Paciente[]
  consultas Consulta[]
  eventos   AgendaEvento[]
}

model Transcript {
  id         Int      @id @default(autoincrement())
  consultaId Int
  text       String
  createdAt  DateTime @default(now())
  consulta   Consulta @relation(fields: [consultaId], references: [id])
}

model AgendaEvento {
  id         Int      @id @default(autoincrement())
  medicoId   Int
  pacienteId Int? // opcional
  consultaId Int? // opcional
  titulo     String
  inicio     DateTime
  fim        DateTime
  origem     String // "whatsapp" | "manual" | "n8n"

  medico   Medico    @relation(fields: [medicoId], references: [id])
  paciente Paciente? @relation(fields: [pacienteId], references: [id])
  consulta Consulta? @relation(fields: [consultaId], references: [id])
}

model ExternalLink {
  id         Int      @id @default(autoincrement())
  consultaId Int
  provider   String // "google"
  externalId String // google_event_id
  calendarId String?
  consulta   Consulta @relation(fields: [consultaId], references: [id])
}

// --- Paciente ---
model Paciente {
  id         Int       @id @default(autoincrement())
  medicoId   Int
  nome       String
  cpf        String    @unique
  email      String?   // opcional
  telefone   String?   // opcional
  nascimento DateTime? // opcional
  endereco   String?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  medico       Medico         @relation(fields: [medicoId], references: [id])
  consultas    Consulta[]
  AgendaEvento AgendaEvento[]

  @@index([medicoId])
}

// --- Consulta ---
model Consulta {
  id         Int      @id @default(autoincrement())
  medicoId   Int
  pacienteId Int
  data       DateTime
  status     Status   @default(ABERTA)

  // caminhos de arquivos no Storage (opcionais, só pra indexar/achar rápido)
  pastaPath       String?
  preAnamnesePath String?
  audioPath       String?
  anamnesePath    String?
  relatorioPath   String?

  createdAt DateTime @default(now())

  medico       Medico         @relation(fields: [medicoId], references: [id])
  paciente     Paciente       @relation(fields: [pacienteId], references: [id])
  Transcript   Transcript[]
  AgendaEvento AgendaEvento[]
  ExternalLink ExternalLink[]

  @@index([medicoId])
  @@index([pacienteId])
  @@index([data])
}
